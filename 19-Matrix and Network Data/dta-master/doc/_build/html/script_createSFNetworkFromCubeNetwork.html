

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating the SF DTA Network from Cube Network and Defining the Scenario &mdash; DTA Anyway 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/dta.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="DTA Anyway 1.0 documentation" href="index.html" />
    <link rel="next" title="Importing Transit Routes" href="script_importTPPlusTransitRoutes.html" />
    <link rel="prev" title="Batch File for Entire Import Process" href="script_importFullSanFranciscoNetworkDataset.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="script_importTPPlusTransitRoutes.html" title="Importing Transit Routes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="script_importFullSanFranciscoNetworkDataset.html" title="Batch File for Entire Import Process"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">DTA Anyway 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-createSFNetworkFromCubeNetwork">
<span id="creating-the-sf-dta-network-from-cube-network-and-defining-the-scenario"></span><h1>Creating the SF DTA Network from Cube Network and Defining the Scenario<a class="headerlink" href="#module-createSFNetworkFromCubeNetwork" title="Permalink to this headline">¶</a></h1>
<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.addCustomResFac">
<tt class="descname">addCustomResFac</tt><big>(</big><em>sanFranciscoCubeNet</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#addCustomResFac"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.addCustomResFac" title="Permalink to this definition">¶</a></dt>
<dd><p>Adjusts response time factors for specific links</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.addShifts">
<tt class="descname">addShifts</tt><big>(</big><em>sanfranciscoCubeNet</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#addShifts"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.addShifts" title="Permalink to this definition">¶</a></dt>
<dd><p>The San Francisco network has a few places where the roadway geometries need clarification via &#8220;shifts&#8221; &#8211;
e.g. some local lanes need to be shifted to be outside the through lanes.</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.addTollLink">
<tt class="descname">addTollLink</tt><big>(</big><em>sanFranciscoCubeNet</em><big>)</big><a class="headerlink" href="#createSFNetworkFromCubeNetwork.addTollLink" title="Permalink to this definition">¶</a></dt>
<dd><p>Adjusts the tollLink field to match the Cube Network VALUETOLL_FLAG field (1 if the link is tolled, otherwise zero)</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.addTurnPockets">
<tt class="descname">addTurnPockets</tt><big>(</big><em>sanfranciscoDynameqNet</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#addTurnPockets"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.addTurnPockets" title="Permalink to this definition">¶</a></dt>
<dd><p>The San Francisco network has a few turn pockets &#8211; add these.</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.allowTurnsFromTransitOnlyLanes">
<tt class="descname">allowTurnsFromTransitOnlyLanes</tt><big>(</big><em>sanfranciscoCubeNet</em>, <em>allVCG</em>, <em>transitVCG</em>, <em>minLinkLength</em>, <em>splitForConnectors=False</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#allowTurnsFromTransitOnlyLanes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.allowTurnsFromTransitOnlyLanes" title="Permalink to this definition">¶</a></dt>
<dd><p>Looks at all the transit-only links and splits them to allow right or left turns for general traffic, if needed.</p>
<p>Splits the link so that the transit section (which is at the start of the link) is <em>minLinkLength</em>.</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.createTransitOnlyLanes">
<tt class="descname">createTransitOnlyLanes</tt><big>(</big><em>sanfranciscoCubeNet</em>, <em>allVCG</em>, <em>transitVCG</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#createTransitOnlyLanes"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.createTransitOnlyLanes" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates transit-only lanes based on the BUSLANE_PM field.</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.encodeATintoFollowupTime">
<tt class="descname">encodeATintoFollowupTime</tt><big>(</big><em>sanfranciscoCubeNet</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#encodeATintoFollowupTime"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.encodeATintoFollowupTime" title="Permalink to this definition">¶</a></dt>
<dd><p>Hack: This is a hack way to pass Area Type to movements for later use. 
This method sets Followup time to 90+AT value.</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.logTransitOnlyLaneDistance">
<tt class="descname">logTransitOnlyLaneDistance</tt><big>(</big><em>sanfranciscoCubeNet</em>, <em>transitVCG</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#logTransitOnlyLaneDistance"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.logTransitOnlyLaneDistance" title="Permalink to this definition">¶</a></dt>
<dd><p>Tallies and logs how much transit-only lane we have (using link.getLength())</p>
</dd></dl>

<dl class="function">
<dt id="createSFNetworkFromCubeNetwork.removeHOVStubs">
<tt class="descname">removeHOVStubs</tt><big>(</big><em>sanfranciscoDynameqNet</em><big>)</big><a class="reference internal" href="_modules/createSFNetworkFromCubeNetwork.html#removeHOVStubs"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#createSFNetworkFromCubeNetwork.removeHOVStubs" title="Permalink to this definition">¶</a></dt>
<dd><p>The San Francisco network has a few &#8220;HOV stubs&#8221; &#8211; links intended to facilitate future coding of HOV lanes
Find these and remove them</p>
</dd></dl>

<div class="section" id="main">
<h2>Main<a class="headerlink" href="#main" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>if __name__ == '__main__':
    
    optlist, args = getopt.getopt(sys.argv[1:], "n:l:")

    if len(args) &lt;= 2:
        print USAGE
        sys.exit(2)
    
    SF_CUBE_NET_FILE            = args[0]
    SF_CUBE_TURN_PROHIBITIONS   = args[1]
    
    SF_CUBE_SHAPEFILE           = None
    if len(args) &gt; 2:
        SF_CUBE_SHAPEFILE       = args[2]

    OUTPUT_NODE_SHAPEFILE       = None
    OUTPUT_LINK_SHAPEFILE       = None
    for (opt,arg) in optlist:
        if opt=="-n":
            OUTPUT_NODE_SHAPEFILE  = arg
        elif opt=="-l":
            OUTPUT_LINK_SHAPEFILE  = arg
            
    # The SanFrancisco network will use feet for vehicle lengths and coordinates, and miles for link lengths
    dta.VehicleType.LENGTH_UNITS= "feet"
    dta.Node.COORDINATE_UNITS   = "feet"
    dta.RoadLink.LENGTH_UNITS   = "miles"

    dta.setupLogging("createSFNetworkFromCubeNetwork.INFO.log", "createSFNetworkFromCubeNetwork.DEBUG.log", logToConsole=True)
        
    # The rest of San Francisco currently exists as a Cube network.  Initialize it from
    # the Cube network files (which have been exported to dbfs.)
    # This is where we define the :py:class:`dta.Scenario`
    sanfranciscoScenario = dta.DynameqScenario(dta.Time(14,30), dta.Time(21,30))

    # We will have 4 vehicle classes: Car_NoToll, Car_Toll, Truck_NoToll, Truck_Toll 
    # We will provide demand matrices for each of these classes
    sanfranciscoScenario.addVehicleClass("Car_NoToll")
    sanfranciscoScenario.addVehicleClass("Car_Toll")
    sanfranciscoScenario.addVehicleClass("Truck_NoToll")
    sanfranciscoScenario.addVehicleClass("Truck_Toll")
    # Transit is an implicit type
    
    # length is in feet (from above), response time is in seconds, maxSpeed is in mi/hour
    # We have only 2 vehicle types                      Type        VehicleClass    Length  RespTime    MaxSpeed    SpeedRatio
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Car",      "Car_NoToll",   21,       1,       100.0,      100.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Car",      "Car_Toll",     21,       1,       100.0,      100.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Truck",    "Truck_NoToll", 31.5,  1.25,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Truck",    "Truck_Toll",   31.5,  1.25,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("LRT1",     "Transit",      75,     1.6,        35.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("LRT2",     "Transit",     150,     1.6,        35.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Trolley_Std",  "Transit",  40,     1.6,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Trolley_Artic","Transit",  60,     1.6,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Motor_Std",    "Transit",  40,     1.6,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("Motor_Artic",  "Transit",  60,     1.6,        70.0,       90.0))
    sanfranciscoScenario.addVehicleType(dta.VehicleType("CableCar",     "Transit",  27.5,   1.6,         9.5,       90.0))    
    dta.DtaLogger.info("Maximum vehicle length = %f" % sanfranciscoScenario.maxVehicleLength())
    # Generic is an implicit type

    # VehicleClassGroups
    allVCG     = dta.VehicleClassGroup(dta.VehicleClassGroup.CLASSDEFINITION_ALL,        dta.VehicleClassGroup.CLASSDEFINITION_ALL,          "#bebebe")
    transitVCG = dta.VehicleClassGroup(dta.VehicleClassGroup.CLASSDEFINITION_TRANSIT,    dta.VehicleClassGroup.CLASSDEFINITION_TRANSIT,      "#55ff00")
    sanfranciscoScenario.addVehicleClassGroup(allVCG)
    sanfranciscoScenario.addVehicleClassGroup(transitVCG)
    sanfranciscoScenario.addVehicleClassGroup(dta.VehicleClassGroup(dta.VehicleClassGroup.CLASSDEFINITION_PROHIBITED, dta.VehicleClassGroup.CLASSDEFINITION_PROHIBITED,   "#ffff00"))
    sanfranciscoScenario.addVehicleClassGroup(dta.VehicleClassGroup("Toll",                           "Car_Toll|Truck_Toll",                              "#0055ff"))
        
    # Generalized cost
    # TODO: Make this better!?!
    sanfranciscoScenario.addGeneralizedCost("Expression_0", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "0",            # link_expr
                                            ""              # descr
                                            )

    sanfranciscoScenario.addGeneralizedCost("Expression_1", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "fac_type_pen*(3600*length/fspeed)",            # link_expr
                                            ""              # descr
                                            )
    sanfranciscoScenario.addGeneralizedCost("Expression_2", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "14.4*length",            # link_expr
                                            ""              # descr
                                            )
    sanfranciscoScenario.addGeneralizedCost("Expression_3", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "14.4*length+fac_type_pen*(1800*length/fspeed)",            # link_expr
                                            ""              # descr
                                            )
    sanfranciscoScenario.addGeneralizedCost("Expression_4", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "fac_type_pen*(1800*length/fspeed)",            # link_expr
                                            ""              # descr
                                            )    
    sanfranciscoScenario.addGeneralizedCost("Expression_5", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "fac_type_pen*(1800*length/fspeed)+(value_toll*379)",            # link_expr
                                            "For Car_Toll - Local and collector penalties and $3 (2012$) toll for tolled links"              # descr
                                            )    
    sanfranciscoScenario.addGeneralizedCost("Expression_6", # name
                                            "Seconds",      # units
                                            "ptime+(left_turn_pc*left_turn)+(right_turn_pc*right_turn)", # turn_expr
                                            "fac_type_pen*(1800*length/fspeed)+(value_toll*10000)",            # link_expr
                                            "For Car_Notoll - Local and collector penalties and prohibitive toll for tolled links"              # descr
                                            )  
    # Read the Cube network
    sanfranciscoCubeNet = dta.CubeNetwork(sanfranciscoScenario)
    centroidIds         = range(1,982)  # centroids 1-981 are internal to SF
    boundaryIds         = [1204,1205,1207,1191,1192,1206,6987,6994,7144,7177,
                           7654,7677,7678,7705,7706,7709,7721,7972,7973,8338,
                           8339,8832]     # externals
    centroidIds.extend(boundaryIds)
   
    # Calculated for freeways and expressways based on Caltrans sensors for freeways in SF
    # Updated for locals/collectors and arterials based on second round MTA speed data
    # Decreased locals/collectors' FFS (especially in residential areas)to account for FF Sapce-Mean-Speed along acc/dec segments before and after stop signs
    # Not to be used with generelized cost function : Expression_1
    speedLookup = { \
        'FT1 AT0':35, 'FT1 AT1':40, 'FT1 AT2':45, 'FT1 AT3':45, 'FT1 AT4':55, 'FT1 AT5':55, 
        'FT2 AT0':60, 'FT2 AT1':65, 'FT2 AT2':65, 'FT2 AT3':65, 'FT2 AT4':70, 'FT2 AT5':70, 
        'FT3 AT0':60, 'FT3 AT1':65, 'FT3 AT2':65, 'FT3 AT3':65, 'FT3 AT4':65, 'FT3 AT5':65, 
        'FT4 AT0':23, 'FT4 AT1':23, 'FT4 AT2':20, 'FT4 AT3':20, 'FT4 AT4':35, 'FT4 AT5':35, 
        'FT5 AT0':30, 'FT5 AT1':30, 'FT5 AT2':35, 'FT5 AT3':35, 'FT5 AT4':40, 'FT5 AT5':40, 
        'FT7 AT0':28, 'FT7 AT1':28, 'FT7 AT2':30, 'FT7 AT3':32, 'FT7 AT4':40, 'FT7 AT5':40, 
        'FT9 AT0':10, 'FT9 AT1':10, 'FT9 AT2':10, 'FT9 AT3':10, 'FT9 AT4':10, 'FT9 AT5':10,         
        'FT11 AT0':18, 'FT11 AT1':18, 'FT11 AT2':18, 'FT11 AT3':15, 'FT11 AT4':35, 'FT11 AT5':35, 
        'FT12 AT0':26, 'FT12 AT1':26, 'FT12 AT2':28, 'FT12 AT3':30, 'FT12 AT4':40, 'FT12 AT5':40, 
        'FT15 AT0':30, 'FT15 AT1':30, 'FT15 AT2':33, 'FT15 AT3':36, 'FT15 AT4':50, 'FT15 AT5':50, 
    }
    # Rise dependent response times from traffic flow study
    responseTimeLookup = { \
    	'FLAT' : 1.0,	'UP' : 1.1,	'DOWN' : 0.9,
    }      
    # see http://code.google.com/p/dta/wiki/NetworkDescriptionForSF
    ftToDTALookup = {"2":1,
                     "3":2,
                     "1":3,
                     "7":4,
                     "15":4,
                     "12":5,
                     "4":6,
                     "11":7,
                     "5":8,
                     # centroid connectors should be what?
                     "6":9,
                     "9":10,
                     }
    
    # Lookup effective length factor (currently set to be 0.95 downtown - AT0&amp;AT1 - and 1.00 elsewhere)
    linkEffectiveLengthFactorLookup = {"AT0":0.95, "AT1":0.95, "AT2":1.0, "AT3":1.0, "AT4":1.0, "AT5":1.0,}
    
    # What is the largest link effective length factor?
    maxLinkEffectiveLengthFactor=max(linkEffectiveLengthFactorLookup.values())

    # We can now calculate minimum link length
    SF_MIN_LINK_LENGTH = round(maxLinkEffectiveLengthFactor*sanfranciscoScenario.maxVehicleLength()/5280.0 + 0.0005,3)
    
    sanfranciscoCubeNet.readNetfile \
      (netFile=SF_CUBE_NET_FILE,
       nodeVariableNames=["N","X","Y","OLD_NODE"],
       linkVariableNames=["A","B","TOLL","USE",
                          "CAP","AT","FT","STREETNAME","TYPE",
                          "MTYPE","SPEED","DISTANCE","TIME",
                          "LANE_AM","LANE_OP","LANE_PM",
                          "BUSLANE_AM","BUSLANE_OP","BUSLANE_PM",
                          "TOLLAM_DA","TOLLAM_SR2","TOLLAM_SR3",
                          "TOLLPM_DA","TOLLPM_SR2","TOLLPM_SR3",
                          "TOLLEA_DA","TOLLEA_SR2","TOLLEA_SR3",
                          "TOLLMD_DA","TOLLMD_SR2","TOLLMD_SR3",
                          "TOLLEV_DA","TOLLEV_SR2","TOLLEV_SR3 ",
                          "VALUETOLL_FLAG","PASSTHRU",
                          "BUSTPS_AM","BUSTPS_OP","BUSTPS_PM",
                          "TSVA","TSIN","BIKE_CLASS","PER_RISE",
     #                    "ONEWAY","PROJ","DTA_EDIT_FL","TOLLTIME",
                          ],
       centroidIds                      = centroidIds,
       useOldNodeForId                  = True,
       nodeGeometryTypeEvalStr          = "Node.GEOMETRY_TYPE_INTERSECTION",
       nodeControlEvalStr               = "RoadNode.CONTROL_TYPE_UNSIGNALIZED",
       nodePriorityEvalStr              = "RoadNode.PRIORITY_TEMPLATE_NONE",
       nodeLabelEvalStr                 = "'boundary' if int(OLD_NODE) in boundaryIds else None",
       nodeLevelEvalStr                 = "None",
       linkReverseAttachedIdEvalStr     = "None", #TODO: fix?
       linkFacilityTypeEvalStr          = "ftToDTALookup[FT]",
       linkLengthEvalStr                = "float(DISTANCE)",
       linkFreeflowSpeedEvalStr         = "45.0 if FT=='6' else float(speedLookup['FT'+FT+' AT'+AT])",
       linkEffectiveLengthFactorEvalStr = "float(linkEffectiveLengthFactorLookup['AT'+AT])",
       linkResponseTimeFactorEvalStr    = "1 if FT=='6' else 1 if FT=='1' else 1 if FT=='2' else 1 if FT=='3' else float(responseTimeLookup['UP' if (float(PER_RISE) &gt; 0.05) else ('FLAT' if (float(PER_RISE) &gt; -0.05) else 'DOWN')])",
       linkNumLanesEvalStr              = "2 if isConnector else (int(LANE_PM) + (1 if int(BUSLANE_PM)&gt;0 else 0))",
       linkRoundAboutEvalStr            = "False",
       linkLevelEvalStr                 = "None",
       linkLabelEvalStr                 = '(STREETNAME if STREETNAME else "") + (" " if TYPE and STREETNAME else "") + (TYPE if TYPE else "")',
       linkGroupEvalStr                 = "-1",
       linkSkipEvalStr                  = "FT=='13'", # skip bike-only
       additionalLocals                 = {'ftToDTALookup':ftToDTALookup,
                                           'speedLookup':speedLookup,
                                           'responseTimeLookup':responseTimeLookup,
                                           'boundaryIds':boundaryIds,
                                           'linkEffectiveLengthFactorLookup':linkEffectiveLengthFactorLookup,
                                           })
    # Apply the transit lanes
    createTransitOnlyLanes(sanfranciscoCubeNet, allVCG, transitVCG)
        
    # create the movements for the network for all vehicles
    sanfranciscoCubeNet.addAllMovements(allVCG, includeUTurns=False)

    # HACK: make movement followup times code for AT of the incoming links
    encodeATintoFollowupTime(sanfranciscoCubeNet)

    # Apply the turn prohibitions
    sanfranciscoCubeNet.applyTurnProhibitions(SF_CUBE_TURN_PROHIBITIONS)
    
    # Read the shape points so curvy streets look curvy
    # 3, 4 are the Broadway Tunnel, being routed too far south in GIS file
    # 5234 # Skip this one link at Woodside/Portola because it overlaps
    # 2798, # Skip this Central Freeway link because Dynameq hates it but I DON'T KNOW WHY
    if SF_CUBE_SHAPEFILE:
        sanfranciscoCubeNet.readLinkShape(SF_CUBE_SHAPEFILE, "A", "B",
                                          skipEvalStr="(OBJECTID in [3,4,5234,2798]) or (MEDIANDIV==1)")
     
    # Some special links needing shifts
    addShifts(sanfranciscoCubeNet)
    
    #Some special links need special response times (in one case to mitigate over-penalizing capacity due to high percent of lane changes)
    addCustomResFac(sanfranciscoCubeNet)

    #Some links may have a toll. Change tollLink field from 0 to 1 if link is tolled
    addTollLink(sanfranciscoCubeNet)
    
    # Convert the network to a Dynameq DTA network
    sanfranciscoDynameqNet = dta.DynameqNetwork(scenario=sanfranciscoScenario)
    sanfranciscoDynameqNet.deepcopy(sanfranciscoCubeNet)
    
    # the San Francisco network has a few "HOV stubs" -- links intended to facilitate future coding of HOV lanes
    removeHOVStubs(sanfranciscoDynameqNet)
    
    # Battery between Bush and Market is a parking garage - forcibly split it
    battery_sbs = sanfranciscoDynameqNet.findLinksForRoadLabels(on_street_label="BATTERY ST", on_direction=dta.RoadLink.DIR_SB,
                                                               from_street_label="BUSH ST", to_street_label="MARKET ST")
    if len(battery_sbs) == 1: sanfranciscoDynameqNet.splitLink(battery_sbs[0])

    # Add virtual nodes and links between Centroids and RoadNodes; required by Dynameq        
    sanfranciscoDynameqNet.insertVirtualNodeBetweenCentroidsAndRoadNodes(startVirtualNodeId=9000000, startVirtualLinkId=9000000,
                                                                         distanceFromCentroid=50)
    
    # Move the centroid connectors from intersection nodes to midblock locations
    # TODO: for dead-end streets, is this necessary?  Or are the midblocks ok?        
    sanfranciscoDynameqNet.moveCentroidConnectorsFromIntersectionsToMidblocks(splitReverseLinks=True, moveVirtualNodeDist=50, externalNodeIds=[], 
                                                                              disallowConnectorEvalStr="True if self.getFacilityType() in [1,8] else False")

    # Allow turns from transit lanes -- this needs to be done after the centroid connectors are moved or they interfere connecting
    # to intersections
    allowTurnsFromTransitOnlyLanes(sanfranciscoDynameqNet, allVCG, transitVCG, minLinkLength=SF_MIN_LINK_LENGTH, splitForConnectors=False)

    # Some special links needing turn pockets
    addTurnPockets(sanfranciscoDynameqNet)
    
    # Add Two-Way stop control to connectors, so vehicles coming out of connectors yield to the vehicles already on the street
    sanfranciscoDynameqNet.addTwoWayStopControlToConnectorsAtRoadlinks()

    # Warn on overlapping links, and move virtual nodes up to 100 feet if that helps
    sanfranciscoDynameqNet.handleOverlappingLinks(warn=True, moveVirtualNodeDist=100)
    
    # finally -- Dynameq requires links to be longer than the longest vehicle x the linkEffectiveLengthFactor
    # rounding up because the lengths are specified with 3 decimals in the file, so if they happen to round down they're too short
    sanfranciscoDynameqNet.handleShortLinks(SF_MIN_LINK_LENGTH,
                                            warn=True,
                                            setLength=True)

    # if we have too many nodes for the license 10
    if sanfranciscoDynameqNet.getNumRoadNodes() &gt; 12500:
        sanfranciscoDynameqNet.removeUnconnectedNodes()
    sanfranciscoDynameqNet.write(dir=r".", file_prefix="sf")
 
    # export the network as shapefiles if requested 
    if OUTPUT_NODE_SHAPEFILE: sanfranciscoDynameqNet.writeNodesToShp(OUTPUT_NODE_SHAPEFILE)
    if OUTPUT_LINK_SHAPEFILE: sanfranciscoDynameqNet.writeLinksToShp(OUTPUT_LINK_SHAPEFILE) 
 
    
    
</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating the SF DTA Network from Cube Network and Defining the Scenario</a><ul>
<li><a class="reference internal" href="#main">Main</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="script_importFullSanFranciscoNetworkDataset.html"
                        title="previous chapter">Batch File for Entire Import Process</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="script_importTPPlusTransitRoutes.html"
                        title="next chapter">Importing Transit Routes</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/script_createSFNetworkFromCubeNetwork.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="script_importTPPlusTransitRoutes.html" title="Importing Transit Routes"
             >next</a> |</li>
        <li class="right" >
          <a href="script_importFullSanFranciscoNetworkDataset.html" title="Batch File for Entire Import Process"
             >previous</a> |</li>
        <li><a href="index.html">DTA Anyway 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-2012, SFCTA Modeling Crew.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>